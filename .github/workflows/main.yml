name: Setup Windows VM and Install Tailscale

on:
  push:
    branches:
      - main

jobs:
  create_vm_and_setup_tailscale:
    runs-on: windows-latest
    steps:
      # 1. Checkout the repository
      - name: Check out repository
        uses: actions/checkout@v2

      # 2. Install AWS CLI (check if it exists, install if missing)
      - name: Install AWS CLI
        run: |
          if (-Not (Get-Command aws -ErrorAction SilentlyContinue)) {
            Write-Host "AWS CLI not found, installing..."
            Invoke-WebRequest -Uri "https://awscli.amazonaws.com/awscli-exe-windows-x86_64.zip" -OutFile "awscliv2.zip"
            Expand-Archive -Path "awscliv2.zip" -DestinationPath "C:\awscli"
            C:\awscli\setup.exe
          } else {
            Write-Host "AWS CLI is already installed"
          }

      # 3. Configure AWS CLI
      - name: Configure AWS CLI with Secrets
        run: |
          aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws configure set default.region us-east-1

      # 4. Install Tailscale using curl from GitHub Releases
      - name: Install Tailscale
        run: |
          $installerPath = "tailscale_installer.msi"
          # Check if installer exists and remove it if it does
          if (Test-Path $installerPath) {
            Write-Host "Removing old installer..."
            Remove-Item $installerPath
          }

          # GitHub Releases direct URL for Tailscale MSI file
          $tailscaleUrl = "https://github.com/tailscale/tailscale/releases/download/v1.30.0/tailscale-1.30.0-x64.msi"  # Correct URL for Windows MSI file

          # Download the installer using curl
          Write-Host "Downloading Tailscale installer from GitHub: $tailscaleUrl"
          curl -L $tailscaleUrl -o $installerPath

          # Verify the installer download (check if the file is not empty or corrupted)
          if ((Get-Item $installerPath).length -eq 0) {
            Write-Host "Installer file is empty or corrupted, exiting..."
            exit 1
          } else {
            Write-Host "Installer downloaded successfully"
          }

          # Install Tailscale using msiexec for better compatibility
          Write-Host "Installing Tailscale..."
          Start-Process -FilePath "msiexec.exe" -ArgumentList "/i", $installerPath, "/quiet", "/norestart" -NoNewWindow -Wait -ErrorAction Stop

      # 5. Set up Tailscale
      - name: Set up Tailscale
        run: |
          Write-Host "Setting up Tailscale..."
          tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }}

      # 6. Restart Windows VM after Tailscale setup
      - name: Restart Windows VM
        run: |
          Write-Host "Restarting the system..."
          Shutdown.exe /r /f /t 0
          Start-Sleep -Seconds 60  # Wait for the system to restart and come back up

      # 7. Launch Windows EC2 Instance
      - name: Launch Windows EC2 Instance
        id: launch_instance
        run: |
          INSTANCE_ID=$(aws ec2 run-instances --image-id ami-xxxxxxxx --count 1 --instance-type t2.micro --key-name my-key-pair --security-group-ids sg-xxxxxxxx --subnet-id subnet-xxxxxxxx --query 'Instances[0].InstanceId' --output text)
          echo "Instance ID: $INSTANCE_ID"
          echo "::set-output name=instance_id::$INSTANCE_ID"

      # 8. Wait for EC2 Instance to be running
      - name: Wait for EC2 Instance to be Running
        run: |
          aws ec2 wait instance-running --instance-ids ${{ steps.launch_instance.outputs.instance_id }}

      # 9. Clean up EC2 instance after setup
      - name: Clean up EC2 instance
        run: |
          aws ec2 terminate-instances --instance-ids ${{ steps.launch_instance.outputs.instance_id }}
          aws ec2 wait instance-terminated --instance-ids ${{ steps.launch_instance.outputs.instance_id }}
