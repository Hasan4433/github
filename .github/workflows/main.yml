name: Setup Windows VM and Install Tailscale

on:
  push:
    branches:
      - main

jobs:
  create_vm_and_setup_tailscale:
    runs-on: windows-latest
    steps:
      # 1. Checkout the repository
      - name: Check out repository
        uses: actions/checkout@v2

      # 2. Install AWS CLI (check if it exists, install if missing)
      - name: Install AWS CLI
        run: |
          if (-Not (Get-Command aws -ErrorAction SilentlyContinue)) {
            Write-Host "AWS CLI not found, installing..."
            Invoke-WebRequest -Uri "https://awscli.amazonaws.com/awscli-exe-windows-x86_64.zip" -OutFile "awscliv2.zip"
            Expand-Archive -Path "awscliv2.zip" -DestinationPath "C:\awscli"
            C:\awscli\setup.exe
          } else {
            Write-Host "AWS CLI is already installed"
          }

      # 3. Configure AWS CLI
      - name: Configure AWS CLI with Secrets
        run: |
          aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws configure set default.region us-east-1

      # 4. Install Tailscale using a specific release URL from GitHub
      - name: Install Tailscale from GitHub
        run: |
          # Set the installer path
          $installerPath = "tailscale_installer.msi"

          # Remove any existing installer file
          if (Test-Path $installerPath) {
            Write-Host "Removing previous installer..."
            Remove-Item $installerPath
          }

          # Download the Tailscale installer directly from GitHub repository
          $tailscaleUrl = "https://github.com/e23awais/tailscale/releases/download/v1.30.0/tailscale-1.30.0-x64.msi"
          Write-Host "Downloading Tailscale installer from GitHub: $tailscaleUrl"
          curl -L $tailscaleUrl -o $installerPath

          # Verify if the installer was downloaded correctly
          if ((Get-Item $installerPath).length -eq 0) {
            Write-Host "Installer file is empty or corrupted, exiting..."
            exit 1
          } else {
            Write-Host "Installer downloaded successfully"
          }

          # Install Tailscale using msiexec for better compatibility
          Write-Host "Installing Tailscale..."
          Start-Process -FilePath "msiexec.exe" -ArgumentList "/i", $installerPath, "/quiet", "/norestart" -NoNewWindow -Wait -ErrorAction Stop

      # 5. Check if Tailscale exists at default path
      - name: Check if Tailscale exists at default path
        run: |
          $tailscalePath = "C:\Program Files\Tailscale\tailscale.exe"
          if (Test-Path $tailscalePath) {
            Write-Host "Tailscale found at $tailscalePath"
          } else {
            Write-Host "Tailscale not found at the default path. Trying 'where tailscale'."
            # Use 'where tailscale' to find the correct path
            $tailscalePath = (where tailscale).Trim()

            # If tailscale is not found, stop the process
            if (-Not $tailscalePath) {
              Write-Host "Tailscale executable not found anywhere, exiting..."
              exit 1
            } else {
              Write-Host "Tailscale found at: $tailscalePath"
            }
          }

      # 6. Set up Tailscale using the found path
      - name: Set up Tailscale
        run: |
          Write-Host "Setting up Tailscale..."
          & $tailscalePath up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }}

      # 7. Restart Windows VM after Tailscale setup
      - name: Restart Windows VM
        run: |
          Write-Host "Restarting the system..."
          Shutdown.exe /r /f /t 0
          Start-Sleep -Seconds 60  # Wait for the system to restart and come back up

      # 8. Launch Windows EC2 Instance
      - name: Launch Windows EC2 Instance
        id: launch_instance
        run: |
          INSTANCE_ID=$(aws ec2 run-instances --image-id ami-xxxxxxxx --count 1 --instance-type t2.micro --key-name my-key-pair --security-group-ids sg-xxxxxxxx --subnet-id subnet-xxxxxxxx --query 'Instances[0].InstanceId' --output text)
          echo "Instance ID: $INSTANCE_ID"
          echo "::set-output name=instance_id::$INSTANCE_ID"

      # 9. Wait for EC2 Instance to be running
      - name: Wait for EC2 Instance to be Running
        run: |
          aws ec2 wait instance-running --instance-ids ${{ steps.launch_instance.outputs.instance_id }}

      # 10. Clean up EC2 instance after setup
      - name: Clean up EC2 instance
        run: |
          aws ec2 terminate-instances --instance-ids ${{ steps.launch_instance.outputs.instance_id }}
          aws ec2 wait instance-terminated --instance-ids ${{ steps.launch_instance.outputs.instance_id }}
